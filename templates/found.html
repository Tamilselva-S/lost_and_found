{% extends "base.html" %}
{% block content %}

<!-- Leaflet CSS & JS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet Locate Control -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css"
/>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>

<h2 class="mb-4">Report a Found Item</h2>

<form method="POST" enctype="multipart/form-data">

  <div class="mb-3">
    <label class="form-label">Your Name</label>
    <input type="text" class="form-control" name="name" required>
  </div>

  <div class="mb-3">
    <label class="form-label">Item Description</label>
    <textarea class="form-control" name="description" rows="3" required></textarea>
  </div>

  <!-- LOCATION SECTION -->
  <div class="mb-3">
    <label class="form-label">Location Found</label>

    <div class="input-group">
      <input type="text"
             class="form-control"
             id="locationInput"
             name="manual_location"
             placeholder="Enter location manually or select from map">

      <button type="button"
              class="btn btn-outline-secondary"
              onclick="openMap()">
        üìç MAP
      </button>
    </div>

    <!-- Map + Actions -->
    <div id="mapContainer" style="display:none;">
      <div id="map"
           style="height:250px; border-radius:8px; margin-top:8px;"></div>

      <div class="d-flex justify-content-end gap-2 mt-2">
        <button type="button"
                class="btn btn-sm btn-success"
                onclick="confirmLocation()">
          ‚úÖ OK
        </button>

        <button type="button"
                class="btn btn-sm btn-outline-danger"
                onclick="cancelLocation()">
          ‚ùå Cancel
        </button>
      </div>
    </div>

    <!-- Hidden fields -->
    <input type="hidden" name="latitude" id="latitude">
    <input type="hidden" name="longitude" id="longitude">
  </div>

  <div class="mb-3">
    <label class="form-label">Contact Info</label>
    <input type="text" class="form-control" name="contact" required>
  </div>

  <!-- Image Upload -->
  <div class="mb-3">
    <label class="form-label">Item Image</label>

    <input type="file"
           id="fileInput"
           name="image"
           accept="image/*"
           class="d-none"
           onchange="previewImage(event)"
           required>

    <input type="file"
           id="cameraInput"
           name="image"
           accept="image/*"
           capture="environment"
           class="d-none"
           onchange="previewImage(event)">

    <div class="d-flex gap-2">
      <button type="button"
              class="btn btn-outline-primary"
              onclick="document.getElementById('fileInput').click()">
        üìÅ Choose File
      </button>

      <button type="button"
              class="btn btn-outline-success"
              onclick="document.getElementById('cameraInput').click()">
        üì∑ Open Camera
      </button>
    </div>
  </div>

  <!-- Image Preview -->
  <div class="mb-3 text-center">
    <img id="preview"
         src=""
         alt="Image Preview"
         class="img-thumbnail"
         style="max-width:200px; display:none;">
  </div>

  <button type="submit" class="btn btn-danger">Submit</button>
</form>

<!-- Scripts -->
<script>
/* IMAGE PREVIEW */
function previewImage(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function () {
    const img = document.getElementById("preview");
    img.src = reader.result;
    img.style.display = "block";
  };
  reader.readAsDataURL(file);
}

/* MAP LOGIC WITH OK / CANCEL + PLACE NAME */
let map, marker;
let tempLat = null, tempLng = null;

function openMap() {
  document.getElementById("mapContainer").style.display = "block";
  if (map) return;

  map = L.map('map').setView([20.5937, 78.9629], 5);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

  marker = L.marker([20.5937, 78.9629], { draggable: true }).addTo(map);

  L.control.locate({
    position: 'topleft',
    flyTo: true,
    showPopup: false,
    locateOptions: { enableHighAccuracy: true }
  }).addTo(map);

  map.on('locationfound', function (e) {
    map.setView(e.latlng, 16);
    marker.setLatLng(e.latlng);
    tempLat = e.latlng.lat;
    tempLng = e.latlng.lng;
  });

  marker.on('dragend', function () {
    const pos = marker.getLatLng();
    tempLat = pos.lat;
    tempLng = pos.lng;
  });
}

function confirmLocation() {
  if (!tempLat || !tempLng) {
    document.getElementById("mapContainer").style.display = "none";
    return;
  }

  document.getElementById("latitude").value = tempLat;
  document.getElementById("longitude").value = tempLng;

  // Reverse geocoding ‚Üí place name
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${tempLat}&lon=${tempLng}`)
    .then(res => res.json())
    .then(data => {
      const placeName =
        data.display_name ||
        `Lat: ${tempLat.toFixed(5)}, Lng: ${tempLng.toFixed(5)}`;

      document.getElementById("locationInput").value = placeName;
      document.getElementById("mapContainer").style.display = "none";
    })
    .catch(() => {
      document.getElementById("locationInput").value =
        `Lat: ${tempLat.toFixed(5)}, Lng: ${tempLng.toFixed(5)}`;
      document.getElementById("mapContainer").style.display = "none";
    });
}

function cancelLocation() {
  tempLat = null;
  tempLng = null;
  document.getElementById("mapContainer").style.display = "none";
}
</script>

{% endblock %}
